# Bug Fixes: Long-Press Status & Datensatz-Handling - 2024-10-19

## üêõ Gemeldete Probleme

### Problem 1: "Alte Datens√§tze Verf√ºgbar" verschwindet nicht
**Symptom:**  
Wenn eine Adresse eingegeben wird und Datens√§tze angezeigt werden, bleibt das Feld "Alte Datens√§tze Verf√ºgbar" auch nach √Ñnderung der Adresse sichtbar.

**Ursache:**  
`showDatasets` State in `scanner.tsx` wurde nicht zur√ºckgesetzt wenn:
1. Adresse gel√∂scht wurde
2. Adresse zu einer anderen Adresse ge√§ndert wurde

---

### Problem 2: Kein Ladescreen beim Datensatz-Erstellen
**Symptom:**  
Beim Erstellen eines Datensatzes gibt es kein visuelles Feedback f√ºr den User.

**Ursache:**  
`isCreatingDataset` State existierte bereits f√ºr Race Condition Prevention, wurde aber nicht im UI angezeigt.

---

### Problem 3: Long-Press-Men√º bei Bestandskunden
**Symptom:**  
Das Status-Men√º wird auch bei Bestandskunden angezeigt und man kann Bestandskunden einen Status zuweisen.

**Ursache:**  
- Frontend: `ResidentRow` erlaubte Long-Press f√ºr alle Kategorien
- Backend: Keine Validierung ob Status nur f√ºr `potential_new_customer` erlaubt ist

**Erwartetes Verhalten:**
- **Bestandskunden:** Long-Press ‚Üí Kategorie-√Ñndern-Men√º (nur "Zu Neukunden verschieben")
- **Neukunden:** Long-Press ‚Üí Status-Men√º (5 Status-Optionen)

---

### Problem 4: Kein Auto-Create beim Status-Zuweisen
**Symptom:**  
Wenn man √ºber Long-Press einen Status zuweisen m√∂chte, aber noch kein Datensatz existiert, passiert nichts.

**Ursache:**  
`handleStatusChange` pr√ºfte nicht ob ein Dataset existiert vor dem Status-Update.

---

### Problem 5: React Warning - setState w√§hrend Render
**Symptom:**  
```
Warning: Cannot update a component (`ScannerPage`) while rendering a different component (`ResultsDisplay`). 
To locate the bad setState() call inside `ResultsDisplay`, follow the stack trace
```

**Ursache:**  
`onResidentsUpdated` wurde w√§hrend `useEffect` aufgerufen (Zeile 192), was zu einem setState w√§hrend Render f√ºhrte.

---

## ‚úÖ Implementierte Fixes

### Fix 1: "Alte Datens√§tze Verf√ºgbar" verschwindet
**Datei:** `client/src/pages/scanner.tsx`

**√Ñnderungen:**
```typescript
useEffect(() => {
  const newNormalizedAddress = createNormalizedAddressString(address);
  
  // FIX: Hide datasets section when address is cleared
  if (!newNormalizedAddress) {
    console.log('[Address Cleared] Hiding datasets section');
    setShowDatasets(false);
    setNormalizedAddress(null);
    return;
  }
  
  // Check if address changed
  if (currentDatasetId && normalizedAddress && newNormalizedAddress) {
    if (normalizedAddress !== newNormalizedAddress) {
      // Clear all state
      setCurrentDatasetId(null);
      setDatasetCreatedAt(null);
      setEditableResidents([]);
      setOcrResult(null);
      setPhotoImageSrc(null);
      setCanEdit(true);
      
      // FIX: Hide datasets section when address changes
      setShowDatasets(false);
      
      toast({
        title: t('dataset.addressChanged', 'Address changed'),
        description: t('dataset.addressChangedDesc', 'Previous dataset was removed'),
      });
    }
  }
  
  setNormalizedAddress(newNormalizedAddress);
}, [address, currentDatasetId, normalizedAddress, t, toast]);
```

**Ergebnis:**
- ‚úÖ Datens√§tze-Liste verschwindet wenn Adresse gel√∂scht wird
- ‚úÖ Datens√§tze-Liste verschwindet wenn Adresse ge√§ndert wird
- ‚úÖ Datens√§tze-Liste erscheint nur wenn `showDatasets` true ist

---

### Fix 2: Ladescreen beim Datensatz-Erstellen
**Datei:** `client/src/components/ResultsDisplay.tsx`

**√Ñnderungen:**
1. **Import Loader2 Icon:**
```typescript
import { User, AlertCircle, UserCheck, UserPlus, Edit, Trash2, X, Loader2 } from 'lucide-react';
```

2. **Loading Dialog hinzugef√ºgt:**
```typescript
return (
  <>
    {/* Dataset Creation Loading Dialog */}
    {isCreatingDataset && (
      <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-background/80 backdrop-blur-sm">
        <Card className="w-full max-w-md mx-4 animate-in fade-in zoom-in-95 duration-200">
          <CardHeader>
            <CardTitle className="flex items-center gap-3">
              <Loader2 className="h-5 w-5 animate-spin text-primary" />
              {t('dataset.creating', 'Datensatz wird erstellt...')}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">
              {t('dataset.creatingDesc', 'Bitte warten, der Datensatz wird angelegt...')}
            </p>
          </CardContent>
        </Card>
      </div>
    )}
    
    {/* ... rest of component */}
  </>
);
```

**Ergebnis:**
- ‚úÖ Fullscreen Loading Dialog w√§hrend Datensatz-Erstellung
- ‚úÖ Spinner-Animation mit Loader2
- ‚úÖ Backdrop verhindert Interaktion w√§hrend Loading
- ‚úÖ z-index 9999 (√ºber allem)

---

### Fix 3: Long-Press nur bei Neukunden ‚Üí Kategorie-Men√º f√ºr Bestandskunden
**Dateien:**
- `client/src/components/ResultsDisplay.tsx`
- `client/src/components/StatusContextMenu.tsx`

**√Ñnderungen in ResultsDisplay.tsx:**

1. **ResidentRow - Long-Press f√ºr alle Kategorien erlauben:**
```typescript
const ResidentRow = ({ resident, index, category }: { ... }) => {
  // FIX: Enable Long Press for both categories (but with different menus)
  const enableLongPress = canEdit;
  
  const longPressHandlers = useLongPress({
    onLongPress: (x, y) => {
      if (!enableLongPress) return;
      setStatusMenuPosition({ x, y });
      setStatusMenuResident({ resident, index });
      setStatusMenuOpen(true);
    },
    onClick: () => {
      if (canEdit) {
        handleEditResidentFromList(resident.name, category);
      }
    }
  });
  // ...
};
```

2. **handleCategoryChange hinzugef√ºgt:**
```typescript
const handleCategoryChange = async (newCategory: ResidentCategory) => {
  if (!statusMenuResident) return;
  const { resident, index } = statusMenuResident;
  
  try {
    // FIX: Auto-create dataset if not exists
    if (!currentDatasetId) {
      const createdDatasetId = await handleRequestDatasetCreation();
      if (!createdDatasetId) {
        setStatusMenuOpen(false);
        setStatusMenuResident(null);
        return;
      }
    }
    
    const updatedResident: EditableResident = {
      ...resident,
      category: newCategory,
      // Clear status when changing to existing_customer
      status: newCategory === 'existing_customer' ? undefined : resident.status
    };

    // Update local state
    setEditableResidents(prev => {
      const newResidents = [...prev];
      newResidents[index] = updatedResident;
      return newResidents;
    });

    // Live-sync to backend
    if (canEdit && currentDatasetId) {
      const allResidents = [...editableResidents];
      allResidents[index] = updatedResident;
      await datasetAPI.bulkUpdateResidents(currentDatasetId, allResidents);
      
      toast({
        title: t('resident.category.updated', 'Kategorie ge√§ndert'),
        description: t('resident.category.updatedDescription', `Kategorie zu {{category}} ge√§ndert`, { 
          category: newCategory === 'existing_customer' ? 'Bestandskunde' : 'Neukunde' 
        }),
      });
    }
  } catch (error) {
    console.error('[handleCategoryChange] Error:', error);
    toast({
      variant: 'destructive',
      title: t('resident.category.error', 'Fehler'),
      description: t('resident.category.errorDescription', 'Kategorie konnte nicht ge√§ndert werden'),
    });
  } finally {
    setStatusMenuOpen(false);
    setStatusMenuResident(null);
  }
};
```

3. **StatusContextMenu mit mode Prop:**
```typescript
<StatusContextMenu
  isOpen={statusMenuOpen}
  x={statusMenuPosition.x}
  y={statusMenuPosition.y}
  onClose={() => {
    setStatusMenuOpen(false);
    setStatusMenuResident(null);
  }}
  onSelectStatus={handleStatusChange}
  onSelectCategory={handleCategoryChange}
  currentStatus={statusMenuResident?.resident.status}
  currentCategory={statusMenuResident?.resident.category}
  mode={statusMenuResident?.resident.category === 'existing_customer' ? 'category' : 'status'}
/>
```

**√Ñnderungen in StatusContextMenu.tsx:**

1. **Interface erweitert:**
```typescript
interface StatusContextMenuProps {
  isOpen: boolean;
  x: number;
  y: number;
  onClose: () => void;
  onSelectStatus?: (status: ResidentStatus) => void;
  onSelectCategory?: (category: ResidentCategory) => void;
  availableStatuses?: ResidentStatus[];
  currentStatus?: ResidentStatus;
  currentCategory?: ResidentCategory;
  mode?: 'status' | 'category';
}
```

2. **Category Mode hinzugef√ºgt:**
```typescript
if (mode === 'category') {
  return createPortal(
    <>
      <div className="fixed inset-0 z-[9998]" style={{ ... }} />
      
      <div ref={menuRef} className="fixed z-[9999] ..." style={{ ... }}>
        <div className="py-2">
          <div className="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider border-b border-gray-200">
            Kategorie √§ndern
          </div>

          <ul className="py-1">
            <li>
              <button
                onClick={() => handleCategoryClick('potential_new_customer')}
                className="w-full px-4 py-3 flex items-center gap-3 ..."
              >
                <span className="text-xl flex-shrink-0">üë§</span>
                <span className="flex-1 text-left font-medium text-[15px] text-amber-600">
                  Zu Neukunden verschieben
                </span>
                {currentCategory === 'potential_new_customer' && (
                  <span className="text-blue-600 text-lg">‚úì</span>
                )}
              </button>
            </li>
          </ul>
        </div>
      </div>
    </>,
    document.body
  );
}
```

**Ergebnis:**
- ‚úÖ **Neukunden (potential_new_customer):** Long-Press ‚Üí Status-Men√º mit 5 Optionen
- ‚úÖ **Bestandskunden (existing_customer):** Long-Press ‚Üí Kategorie-Men√º mit "Zu Neukunden verschieben"
- ‚úÖ Kategorie-√Ñnderung l√∂scht Status automatisch
- ‚úÖ Auto-Create Dataset wenn nicht vorhanden

---

### Fix 4: Backend-Validierung f√ºr Status
**Datei:** `server/routes/addressDatasets.ts`

**√Ñnderungen:**
```typescript
router.put('/bulk-residents', async (req, res) => {
  try {
    const data = bulkUpdateResidentsRequestSchema.parse(req.body);
    const username = (req as any).username;
    
    if (!username) {
      return res.status(401).json({ error: 'Authentication required' });
    }

    // FIX: Validate that only potential_new_customer can have status
    for (const resident of data.editableResidents) {
      if (resident.status && resident.category !== 'potential_new_customer') {
        console.error(`[Bulk Update] VALIDATION ERROR: Cannot assign status to ${resident.category}:`, resident);
        return res.status(400).json({ 
          error: 'Status can only be assigned to potential new customers', 
          details: `Resident "${resident.name}" has category "${resident.category}" but status is only allowed for "potential_new_customer"` 
        });
      }
    }

    // Get the dataset to check permissions
    const dataset = await addressDatasetService.getDatasetById(data.datasetId);
    
    // ... rest of handler
  } catch (error) {
    // ... error handling
  }
});
```

**Ergebnis:**
- ‚úÖ Backend validiert dass nur `potential_new_customer` einen Status haben darf
- ‚úÖ 400 Bad Request wenn Validation fehlschl√§gt
- ‚úÖ Detaillierte Fehlermeldung mit Resident-Name und Kategorie

---

### Fix 5: Auto-Create Dataset beim Status-Zuweisen
**Datei:** `client/src/components/ResultsDisplay.tsx`

**√Ñnderungen in handleStatusChange:**
```typescript
const handleStatusChange = async (newStatus: ResidentStatus) => {
  if (!statusMenuResident) return;
  const { resident, index } = statusMenuResident;
  
  try {
    // FIX: If no dataset exists yet, create one first
    if (!currentDatasetId) {
      console.log('[handleStatusChange] No dataset exists, creating one first...');
      const createdDatasetId = await handleRequestDatasetCreation();
      if (!createdDatasetId) {
        console.log('[handleStatusChange] Dataset creation failed or was cancelled');
        setStatusMenuOpen(false);
        setStatusMenuResident(null);
        return;
      }
      console.log('[handleStatusChange] Dataset created:', createdDatasetId);
    }
    
    const updatedResident: EditableResident = {
      ...resident,
      status: newStatus
    };

    // Update local state
    setEditableResidents(prev => {
      const newResidents = [...prev];
      newResidents[index] = updatedResident;
      return newResidents;
    });

    // Live-sync to backend
    if (canEdit && currentDatasetId) {
      const allResidents = [...editableResidents];
      allResidents[index] = updatedResident;
      await datasetAPI.bulkUpdateResidents(currentDatasetId, allResidents);
      
      // Track action
      trackingManager.logAction(
        'status_change',
        `Resident: ${resident.name}`,
        newStatus as 'interessiert' | 'nicht_interessiert' | 'nicht_angetroffen' | 'termin_vereinbart'
      );

      toast({
        title: t('resident.status.updated', 'Status updated'),
        description: t('resident.status.updatedDescription', `Status changed to {{status}}`, { 
          status: newStatus 
        }),
      });
    }
  } catch (error) {
    console.error('[handleStatusChange] Error:', error);
    toast({
      variant: 'destructive',
      title: t('resident.status.error', 'Error'),
      description: t('resident.status.errorDescription', 'Failed to update status'),
    });
  } finally {
    setStatusMenuOpen(false);
    setStatusMenuResident(null);
  }
};
```

**Ergebnis:**
- ‚úÖ Dataset wird automatisch erstellt wenn nicht vorhanden
- ‚úÖ Loading Dialog wird w√§hrend Erstellung angezeigt
- ‚úÖ Status wird nach erfolgreicher Dataset-Erstellung gesetzt
- ‚úÖ Bei Fehler/Cancel wird Men√º geschlossen ohne Status zu setzen

---

### Fix 6: React Warning - setState w√§hrend Render
**Datei:** `client/src/components/ResultsDisplay.tsx`

**Problem war bereits behoben in Zeile 192-208:**
```typescript
// FIX: Notify parent of resident changes AFTER state update (prevents React warning)
// Only notify if residents actually changed (prevents infinite loops)
useEffect(() => {
  // Compare with previous value using JSON.stringify (deep equality)
  const currentJSON = JSON.stringify(editableResidents);
  const prevJSON = JSON.stringify(prevResidentsRef.current);
  
  if (currentJSON !== prevJSON) {
    console.log('[ResultsDisplay] Residents changed, notifying parent:', editableResidents.length);
    prevResidentsRef.current = editableResidents; // Update ref BEFORE calling callback
    onResidentsUpdated?.(editableResidents);
  } else {
    console.log('[ResultsDisplay] Residents unchanged, skipping parent notification');
  }
}, [editableResidents]); // Intentionally exclude onResidentsUpdated to prevent infinite loops
```

**Ergebnis:**
- ‚úÖ `onResidentsUpdated` wird in separatem useEffect aufgerufen
- ‚úÖ Kein setState w√§hrend Render mehr
- ‚úÖ Deep Equality Check verhindert unn√∂tige Updates
- ‚úÖ prevResidentsRef verhindert Infinite Loops

---

## üìä Zusammenfassung der √Ñnderungen

### Ge√§nderte Dateien:
1. **client/src/pages/scanner.tsx**
   - `showDatasets` State Management verbessert
   - Auto-Hide bei Adresse l√∂schen/√§ndern

2. **client/src/components/ResultsDisplay.tsx**
   - Loading Dialog hinzugef√ºgt
   - `handleCategoryChange` Funktion
   - `handleStatusChange` mit Auto-Create
   - ResidentRow Long-Press f√ºr alle Kategorien
   - StatusContextMenu mit `mode` Prop

3. **client/src/components/StatusContextMenu.tsx**
   - `mode` Prop hinzugef√ºgt ('status' | 'category')
   - `onSelectCategory` Callback
   - Category Mode UI implementiert

4. **server/routes/addressDatasets.ts**
   - Backend-Validierung f√ºr Status
   - 400 Error wenn Status bei Bestandskunden

### Features:
- ‚úÖ **Ladescreen:** Fullscreen Loading w√§hrend Datensatz-Erstellung
- ‚úÖ **Long-Press Neukunden:** Status-Men√º mit 5 Optionen
- ‚úÖ **Long-Press Bestandskunden:** Kategorie-Men√º ("Zu Neukunden verschieben")
- ‚úÖ **Auto-Create Dataset:** Bei Status/Kategorie-√Ñnderung
- ‚úÖ **Backend-Validierung:** Nur Neukunden d√ºrfen Status haben
- ‚úÖ **Datens√§tze-Liste:** Verschwindet bei Adresse l√∂schen/√§ndern

### Bug Fixes:
- ‚úÖ "Alte Datens√§tze Verf√ºgbar" verschwindet korrekt
- ‚úÖ Loading Feedback beim Datensatz-Erstellen
- ‚úÖ Status nur f√ºr Neukunden (Frontend + Backend)
- ‚úÖ Kategorie-√Ñnderung f√ºr Bestandskunden
- ‚úÖ Auto-Create Dataset funktioniert
- ‚úÖ React Warning behoben

---

## üß™ Test-Szenarien

### Szenario 1: Datens√§tze-Liste verschwindet
1. Adresse eingeben ‚Üí Datens√§tze-Liste erscheint ‚úÖ
2. Adresse l√∂schen ‚Üí Datens√§tze-Liste verschwindet ‚úÖ
3. Neue Adresse eingeben ‚Üí Datens√§tze-Liste erscheint wieder ‚úÖ

### Szenario 2: Loading beim Dataset-Erstellen
1. OCR durchf√ºhren
2. Resident hinzuf√ºgen ‚Üí **Loading Dialog erscheint** ‚úÖ
3. Dataset wird erstellt
4. Loading verschwindet, Toast erscheint ‚úÖ

### Szenario 3: Long-Press Neukunde
1. Neukunden-Eintrag Long-Press
2. Status-Men√º mit 5 Optionen erscheint ‚úÖ
3. Status ausw√§hlen ‚Üí Status wird gesetzt ‚úÖ
4. Wenn kein Dataset: Auto-Create ‚úÖ

### Szenario 4: Long-Press Bestandskunde
1. Bestandskunden-Eintrag Long-Press
2. Kategorie-Men√º mit "Zu Neukunden verschieben" erscheint ‚úÖ
3. Ausw√§hlen ‚Üí Kategorie wird zu `potential_new_customer` ‚úÖ
4. Status wird gel√∂scht (falls vorhanden) ‚úÖ

### Szenario 5: Backend-Validierung
1. Versuche √ºber API Bestandskunden einen Status zu geben
2. Backend: 400 Bad Request ‚úÖ
3. Fehlermeldung mit Details ‚úÖ

---

## üöÄ Status

**Alle Fixes implementiert:** ‚úÖ  
**Ready for Testing:** ‚úÖ  
**Datum:** 2024-10-19

**N√§chste Schritte:**
1. Server neu starten
2. Test-Szenarien durchf√ºhren
3. Feedback geben

